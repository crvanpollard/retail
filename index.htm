<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="description" content="">
        <meta name="author" content="">
        <title>DVRPC Retail Districts</title>

        <!-- Core CSS -->
        <link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@0.7/dist/leaflet.css" />


        <!-- Custom styles for this template -->
        <style>
            html, body, #sidebar, #container {
                height: 100%;
                margin: 0px;
            }
            body {
                padding-top: 50px;
            }
            label {
                font-weight: normal;
            }
            #map {
                height: 100%;
                margin: 0px;
                /*-webkit-box-shadow: 0 -1px 10px rgba(0,0,0,0.5);
                -moz-box-shadow: 0 -1px 10px rgba(0,0,0,0.5);
                box-shadow: 0 -1px 10px rgba(0,0,0,0.5);*/
                border: 1px solid #999;
                overflow: hidden;
            }
            #loading {
                position: absolute;
                width: 220px;f
                height: 19px;
                top: 50%;
                left: 50%;
                margin: -10px 0 0 -110px;
                z-index: 20001;
                display: none !important;
            }
            .searchbox {
                -webkit-border-top-left-radius: 4px;
                -webkit-border-bottom-left-radius: 4px;
                -moz-border-top-left-radius: 4px;
                -moz-border-bottom-left-radius: 4px;
                border-top-left-radius: 4px;
                border-bottom-left-radius: 4px;
            }
            .table {
                margin-bottom: 0px;
            }
            .navbar-inverse {
                background-color:#0078ae;
            }
            .navbar .navbar-brand {
                font-weight: bold;
                font-size: 22px;
                white-space: nowrap;
                color:white;
            }
            .navbar-inverse .navbar-nav>li>a {
                color:white;
            }
            .navbar-collapse.in {
                overflow-y: hidden;
            }
            .twitter-typeahead {
                display:block !important;
            }
            .tt-dropdown-menu {
                overflow: auto;
                right:0 !important;
            }
            .tt-hint, .tt-query {
                display: block;
                width: 100%;
                height: 34px;
                padding: 6px 12px;
                font-size: 14px;
                border-radius: 4px;
            }
            .typeahead-header {
                margin: 0 5px 5px 5px;
                padding: 3px 0;
                border-bottom: 2px solid #333;
            }
            .tt-suggestion + .tt-suggestion {
                border-top: 1px solid #ccc;
            }
            .search-container {
                width: 250px;
            }
            .leaflet-popup-content, .leaflet-popup-content .panel {
                margin: 0;   
            }
            .leaflet-popup-content-wrapper {
                border-radius: 5px;
                padding:0px;
            }
            .panel-heading a:hover {
                text-decoration: none;
            }
            .panel-primary>.panel-heading a {
                color: white;
            }
            .panel-primary {
                border-color:#0078ae;
            }
            .panel-primary>.panel-heading {
                background-color:#0078ae;
                border-color:#0078ae;
            }
            
            #easy-as-pie-chart {
              font: 10px sans-serif;
              text-shadow: none;
            }
            #easy-as-pie-chart .total{
              font-size: 18px;
              font-weight: bold;
            }
            #easy-as-pie-chart .units{
              fill: gray;
              font-size: 12px;
            }
            #easy-as-pie-chart .label{
              fill: #CCC;
              font-size: 15px;
              font-weight: bold;
            }
            #easy-as-pie-chart .value{
              font-size: 12px;
              font-weight: bold;
            }
            .Yes {
                display: inline !important;
            }
            .No {
                display: none !important;
            }
            .\(NRHP\):after {
                content: ' (NRHP)';
            }
            td.right {
                text-align: right;
            }
            .tt-suggestions {
            padding-left: 0;
            text-align: left;
            }
            .tt-suggestion:last-child {
            margin-bottom: 0;
            border-bottom-right-radius: 4px;
            border-bottom-left-radius: 4px;
            }
            .tt-suggestion:first-child {
            border-top-right-radius: 4px;
            border-top-left-radius: 4px;
            }
            .tt-suggestion {
            position: relative;
            display: block;
            padding: 10px 15px;
            margin-bottom: -1px;
            background-color: #fff;
            border: 1px solid #ddd;
            }
            .tt-suggestion:hover {
                background-color:#f5f5f5;
                cursor: pointer;
            }
            .tt-suggestion p {
                margin: 0;
            }
            .modal .tt-dropdown-menu {
                bottom: 100% !important;
                top: initial !important;
            }

            @media print {
                .navbar, #map, footer, .print {
                    display: none;
                }

                #sidebar, #chart-container {
                    width: 100%;
                    background: transparent;
                    color:black;
                }
            
                body, #sidebar {
                    padding: 0;
                    overflow: visible;
                }
            }

            h3.media-heading {
                font-size:16px;
                border-bottom: 1px solid #ccc;
                font-weight:bold;
                margin:0 0 10px;
                padding:5px 0;
                color: #333;
            }

            h4.media-heading {
                font-size: 14px;
                color: #333;
                margin: 0;
            }
            .media-body {
                color:#999;
            }
            .navbar-inverse .navbar-toggle, .navbar-inverse .navbar-toggle:hover, .navbar-inverse .navbar-toggle:focus {
                background-color: transparent;
                border-color: white;
                color: white;
                outline: none;
            }
            .modal-body>:first-child {
                margin-top:0;
                padding-top:0;
            }
            #chart-container {
                background: #DFE9F1;
                padding: 10px;
                border-bottom-right-radius: 20px;
                position:absolute;
                z-index:200;
                border-bottom: 1px solid #999;
                border-right: 1px solid #999;
            }
            @media (max-width: 767px) {
                .navbar-inverse .navbar-nav .open .dropdown-menu>li>a {
                    color: white;
                }
                #chart-container {
                    position:relative;
                }
            }
            .navbar-inverse .navbar-collapse, .navbar-inverse .navbar-form {
                border-color: transparent;
                -webkit-box-shadow: none;
                box-shadow: none;
            }

            
            .title-row {
                background: #DFE9F1;
                padding: 10px 10px 10px 0;
            }
            *:focus {
                outline: none !important;
            }
            .glyphicon-empty {
                height: 1em;
                border-radius:50%;
                overflow: hidden;
            }
            .legend-item {
                display: inline-block;
                font-size: 12px;
                color:gray;
                padding-right:10px;
            }
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
            <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.2.0/respond.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle btn" data-toggle="collapse" data-target=".navbar-collapse" style="height: 34px; padding: 5px 10px; margin-right: 10px;"><i class="fa fa-ellipsis-v"></i></button>
                <button id="toggle" type="button" class="navbar-toggle btn" style="height: 34px; padding: 5px 10px; margin-right: 10px;"><i id="toggleIcon" class="glyphicon glyphicon-stats"></i></button>
                <a class="navbar-brand" href="//www.dvrpc.org/" target="_blank"><img src="//www.dvrpc.org/webmaps/tcdi/images/dvrpc_logo.png" alt="DVRPC" style="max-height:40px;margin:-10px 10px -10px 0;"/> Suburban Retail Districts</a>
            </div>
            <div class="navbar-collapse collapse" id="navbar-collapse">
                <form class="navbar-form navbar-right">
                    <div class="input-group search-container">
                        <input type="text" class="searchbox form-control" placeholder="Search">
                        <span class="input-group-addon"><i class="fa fa-search"></i></span>
                    </div>
                </form>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" onclick="$('#aboutModal').modal('show'); return false;"><i class="glyphicon glyphicon-info-sign" style="color: white"></i>&nbsp;&nbsp;About</a></li>
                    <li class="dropdown">
                        <a id="toolsDrop" href="#" role="button" class="dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-wrench" style="color: white"></i>&nbsp;&nbsp;Tools and Data<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" onclick="map.fitBounds(retail.getBounds()); return false;"><i class="glyphicon glyphicon-resize-full"></i>&nbsp;&nbsp;Zoom To Region</a></li>
                            <!--<li><a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" onclick="$('#legendModal').modal('show'); return false;"><i class="glyphicon glyphicon-picture"></i>&nbsp;&nbsp;Show Legend</a></li>-->
                            <li><a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" onclick="$('#loginModal').modal('show'); return false;"><i class="glyphicon glyphicon-warning-sign"></i>&nbsp;&nbsp;View Disclaimer</a></li>
                            <li class="divider"></li>
                            <li><a href="//www.dvrpc.org/LandUse/SOS/xls/DVRPC_Retail_District_Data_011714.xls"><i class="glyphicon glyphicon-download-alt"></i>&nbsp;&nbsp;Download Spreadsheet <small style="opacity:0.6">[0.1 MB xls]</small></a></li>
                        </ul>
                    </li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>

        <div class="row" id="container">
            <div class="col-sm-5 col-lg-5" id="sidebar" style="padding: 0 15px; overflow: auto; display:none;">
                <div id="tmpl-content" data-observe>
                    <div class="row title-row">
                        <div class="col-sm-12">
                            <h3 style="margin-top:0;"><span data-var="District"></span><br/><small><span data-var="RDISTCROSS"></span>, <span data-var="COUNTY"></span> County, <span data-var="STATE"></span></small></h3>
                            <span class="label label-default" data-var="CONCAT"></span> <span class="label label-default" data-class-var="CENTER">Center</span> <span class="label label-default" data-class-var="CTOWN">Classic Town</span> <span class="label label-default" data-class-var="HDIST">Historic District</span> <span class="label label-default" data-class-var="TRANSIT">Transit-Oriented</span>
                        </div>
                    </div>
                    <div class="row js-masonry" style="margin-top:1em" data-masonry-options='{"transitionDuration": "0.1s", "columnWidth": ".col-lg-4"}'>
                        <div class="col-sm-6 col-lg-4">
                            <div class="media">
                                <div class="media-body">
                                    <h3 class="media-heading">Transit and Accessibility</h3>
                                    <ul class="media-list">
                                        <li class="media" data-exists="DTRETAIL">
                                            <div class="media-body">
                                                <h4 class="media-heading">Number of Blocks</h4><span data-var="DTRETAIL"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="MAXSWW">
                                            <div class="media-body">
                                                <h4 class="media-heading">Maximum Sidewalk Width</h4><span data-var="MAXSWW"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="MAXCARTW">
                                            <div class="media-body">
                                                <h4 class="media-heading">Maximum Cartway Width</h4><span data-var="MAXCARTW"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="WSCORE">
                                            <div class="media-body">
                                                <h4 class="media-heading">Walk Score</h4><span data-var="WSCORE"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="TRANSIT">
                                            <div class="media-body">
                                                <h4 class="media-heading">Transit</h4><span data-var="TRANSIT"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="BUSROUTE">
                                            <div class="media-body">
                                                <h4 class="media-heading">Bus Routes</h4><span data-var="BUSROUTE"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="PARKING">
                                            <div class="media-body">
                                                <h4 class="media-heading">Parking</h4><span data-var="PARKING"></span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="media">
                                <div class="media-body">
                                    <h3 class="media-heading">Demographics <small>within &half; mile</small></h3>
                                    <ul class="media-list">
                                        <li class="media" data-exists="POPHALF">
                                            <div class="media-body">
                                                <h4 class="media-heading">Population</h4>
                                                <span data-var="POPHALF"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="HHHALF">
                                            <div class="media-body">
                                                <h4 class="media-heading">Households</h4>
                                                <span data-var="HHHALF"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="MEDHHQ">
                                            <div class="media-body">
                                                <h4 class="media-heading">Median Household Income</h4>
                                                $<span data-var="MEDHHQ"></span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-6 col-lg-4">
                            <div class="media">
                                <div class="media-body">
                                    <h3 class="media-heading">Management Structure</h3>
                                    <ul class="media-list">
                                        <li class="media" data-exists="BID">
                                            <div class="media-body">
                                                <h4 class="media-heading">Business Improvement District</h4><span data-var="BID"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="CHAMCOM">
                                            <div class="media-body">
                                                <h4 class="media-heading">Chamber of Commerce</h4><span data-var="CHAMCOM"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="BUSASC">
                                            <div class="media-body">
                                                <h4 class="media-heading">Business Association</h4><span data-var="BUSASC"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="MERCHASC">
                                            <div class="media-body">
                                                <h4 class="media-heading">Merchants Association</h4><span data-var="MERCHASC"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="MAINST">
                                            <div class="media-body">
                                                <h4 class="media-heading">Main Street</h4><span data-var="MAINST"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="ZONING">
                                            <div class="media-body">
                                                <h4 class="media-heading">Zoning</h4><span data-var="ZONING"></span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="media">
                                <div class="media-body">
                                    <h3 class="media-heading">Traffic Counts</h3>
                                    <ul class="media-list">
                                        <li class="media" data-exists="CENTERPT">
                                            <div class="media-body">
                                                <h4 class="media-heading">Center Point</h4><span data-var="CENTERPT"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="AADT">
                                            <div class="media-body">
                                                <h4 class="media-heading">AADT</h4><span data-var="AADT" data-var-format="0,0"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="COUNTLOC">
                                            <div class="media-body">
                                                <h4 class="media-heading">Count Location</h4><span data-var="COUNTLOC"></span>
                                            </div>
                                        </li>
                                        <li class="media" data-exists="DATE">
                                            <div class="media-body">
                                                <h4 class="media-heading">Date</h4><span data-var="DATE"></span>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row"><div class="col-xs-12"><button href="#" onclick="window.print();return false" class="print btn btn-primary pull-right"><i class="glyphicon glyphicon-print"></i> PRINT</button></div></div>
                </div>
            </div>
            <div class="col-sm-3 col-sm-offset-5" id="chart-container" style="display:none">
                <div id="easy-as-pie-chart"></div>
                <div>
                    <div class="legend-item"><i class="glyphicon glyphicon-empty" style="background:#42708A;"></i> Civic &amp; Cultural</div>
                    <div class="legend-item"><i class="glyphicon glyphicon-empty" style="background:#79AAC7;"></i> F &amp; B</div>
                    <div class="legend-item"><i class="glyphicon glyphicon-empty" style="background:#9BBFD5;"></i> GAFO</div>
                    <div class="legend-item"><i class="glyphicon glyphicon-empty" style="background:#5895B9;"></i> NG &amp; S</div>
                    <div class="legend-item"><i class="glyphicon glyphicon-empty" style="background:#2C4B5D;"></i> Office</div>
                    <div class="legend-item"><i class="glyphicon glyphicon-empty" style="background:#C66554;"></i> Residential</div>
                    <div class="legend-item"><i class="glyphicon glyphicon-empty" style="background:#A7A9AC;"></i> Vacant</div>
                </div>
            </div>
            <div class="col-sm-12 col-lg-12" id="map">
            </div>
        </div>

        <div class="modal fade" id="aboutModal">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title"><img src="//www.dvrpc.org/webmaps/tcdi/images/dvrpc_logoX.png" alt="DVRPC"/> Delaware Valley Suburban Retail Districts</h2>
                    </div>
                    <div class="modal-body">
                         
                        <h3>About</h3>
                        <p>Through the Strategies for Older Suburbs work program, staff compiled information about 71 suburban downtown retail districts in an effort to learn what elements were common among successful older suburban retail districts.  The information provided through this web application is the culmination of field work and research done by DVRPC staff.  The information about each downtown's retail mix was collected between January and April 2013.  Retail elements included in this analysis include: management structure, sidewalk width, walkscore, vacancy rate, parking options, anchor institutions, AADTs, Streetscape, national tenancy, lease rents, historic districts, household income, transit accessibility, residential population, events, open space, retail mix, and blocks included for analysis. </p>
                        
                        <p>If you have further questions, please contact Karen Cilurso, <a href="mailto:kpcilurso@dvrpc.org"><i class="glyphicon glyphicon-envelope"></i> kpcilurso@dvrpc.org</a></p>

                        <h3>Getting Started</h3>
                        <p>Click Continue to browse a map of the Delaware Valley region. Click on a retail district to view detailed information. If you know a specific district, you can search for it in the search bar.
                        </p>
                        
                    </div>
                    <div class="modal-footer">
                        <div class="pull-left"><div class="input-group search-container">
                            <input type="text" class="searchbox form-control" placeholder="Search">
                            <span class="input-group-addon"><i class="fa fa-search"></i></span>
                        </div></div>
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Continue</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <div class="modal fade" id="legendModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Map Legend</h4>
                    </div>
                    <div class="modal-body">
                        <p>Map Legend goes here...</p>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <div class="modal fade" id="loginModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Disclaimer</h4>
                    </div>
                    <div class="modal-body">
                        <p>This web page is a public resource of general information. The Delaware Valley Regional Planning Commission (DVRPC) makes no warranty, representation, or guarantee as to the content, sequence, accuracy, timeliness, or completeness of any of the spatial data or database information provided herein. DVRPC and partner state, local, and other agencies shall assume no liability for errors, omissions, or inaccuracies in the information provided regardless of how caused; or any decision made or action taken or not taken by any person relying on any information or data furnished within.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary pull-right" data-dismiss="modal">Close</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <div class="modal fade" id="featureModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title text-primary" id="feature-title"></h4>
                    </div>
                    <div class="modal-body" id="feature-info">
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="https://masonry.desandro.com/masonry.pkgd.min.js"></script>
        <script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
        <script src="https://unpkg.com/leaflet@0.7/dist/leaflet.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.1/d3.min.js"></script>
        <script type="text/javascript" src="js/typeahead.bundle.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.5.2/numeral.min.js"></script>
        <script type="text/javascript">
        (function ($) {
            $.observe = function(data) {
                $.observe.vars = $.observe.vars || $('[data-observe] [data-var]');
                $.observe.vars.each(function () {
                    $(this).html(data[$(this).data('var')]);
                });

                $.observe.exists = $.observe.exists || $('[data-observe] [data-exists]');
                $.observe.exists.each(function () {
                    $(this).data('exists') in data && !!data[$(this).data('exists')] ? $(this).show() : $(this).hide();
                });

                $.observe.css = $.observe.css || $('[data-observe] [data-class-var]');
                $.observe.css.each(function () {
                    if (!!$(this).data('class-var-stored')) {
                        $(this).removeClass($(this).data('class-var-stored'));
                    }
                    if ($(this).data('class-var') in data && !!data[$(this).data('class-var')]) {
                        $(this).addClass(data[$(this).data('class-var')]);
                        $(this).data('class-var-stored', data[$(this).data('class-var')]);
                    }
                    else {
                        $(this).removeClass($(this).data('class-var-stored'));
                    }
                });
            }
            $.observe.vars;
            $.observe.exists;
            $.observe.css;
        }(jQuery))
        
        </script>
        <script type="text/javascript">
            L.Map.include({

                setView: function (center, zoom, options) {

                    zoom = zoom === undefined ? this._zoom : this._limitZoom(zoom);
                    center = this._limitCenter(L.latLng(center), zoom, this.options.maxBounds);
                    options = options || {};

                    if (this._panAnim) {
                        this._panAnim.stop();
                    }

                    if (this._loaded && !options.reset && options !== true) {

                        if (zoom !== this._zoom) this._resetView(this.getCenter(), zoom);
                        options.paddingTopLeft = options.paddingTopLeft === undefined ? [0,0] : options.paddingTopLeft;
                        center = this.containerPointToLatLng([this.latLngToContainerPoint(center).x - options.paddingTopLeft[0], this.latLngToContainerPoint(center).y - options.paddingTopLeft[1]]);
                        
                        if (options.animate !== undefined) {
                            options.zoom = L.extend({animate: options.animate}, options.zoom);
                            options.pan = L.extend({animate: options.animate}, options.pan);
                        }

                        // try animating pan or zoom
                        var animated = (this._zoom !== zoom) ?
                            this._tryAnimatedZoom && this._tryAnimatedZoom(center, zoom, options.zoom) :
                            this._tryAnimatedPan(center, options.pan);

                        if (animated) {
                            // prevent resize handler call, the view will refresh after animation anyway
                            clearTimeout(this._sizeTimer);
                            return this;
                        }
                    }

                    // animation didn't start, just reset the map view
                    this._resetView(center, zoom);

                    return this;
                }
            });

            var map, boroughSearch = [], theaterSearch = [], museumSearch = [];

            function getTemplateFromProperties(properties, title, whitelist) {
                //return $.observe(properties);
                /*var props = {};
                if (typeof whitelist != 'undefined') {
                    for (prop in whitelist) {
                        var p = whitelist[prop];
                        props[p] = properties[p];
                    }
                }
                else {
                    props = properties;
                }

                var content = ['<div class="panel panel-primary table-responsive"><div class="panel-heading">' + title + '</div><table class="table table-striped table-condensed"><tbody>'];
                for (property in props) {
                    content.push('<tr><td>' + property + '</td><td>' + props[property] + '</td></tr>');
                }

                content.push('</tbody></table></div>');
                return content.join('');*/
            }

            function applyFormat(data, map) {
                return data;
                return $.map(data, function(v, k) {
                    return (k in map) ? numeral(v).format(map[k]) : v;
                });
            }

            var map = {

            };
            
            var activeMarker = null;
            function onEachFeature(feature, layer) {
                if (feature.properties) {
                    layer.on({
                        click: function(e) {
                            $(e.target._icon).tooltip('hide');
                            /*$('#sidebar').fadeIn(0, function() {
                                update([e.target.feature]);
                                $.observe(e.target.feature.properties);
                                $('.js-masonry').masonry();
                            });*/
                            if (document.body.clientWidth <= 767) {
                                $('#toggle').click(function () {
                                    update([e.target.feature]);
                                    $.observe(applyFormat(e.target.feature.properties, map));
                                    $('.js-masonry').masonry();
                                    $('.navbar-collapse').collapse('hide');
                                }).trigger('click');
                            } else {
                                $('#map').attr('class', 'col-sm-7 col-lg-7');
                                if ($('#sidebar').is(':hidden')) {
                                    $('#sidebar, #chart-container').show();
                                    setupd3();
                                    update([e.target.feature]);
                                }
                                update([e.target.feature]);
                                $.observe(applyFormat(e.target.feature.properties, map));
                                $('.js-masonry').masonry();
                                map.invalidateSize();
                                
                            }
                            map.setView(e.latlng, 15, {paddingTopLeft: document.body.clientWidth <= 767 ? [0, 0]: [150, 150]});
                            if (activeMarker) activeMarker.setIcon(icon);
                            activeMarker = e.target.setIcon(activeIcon);
                        }
                    });
                }
            }

            $(document).ready(function() {
                $("[rel=tooltip]").tooltip();
                //$("#map").prop("class", "col-sm-12 col-lg-12");
                //$("#sidebar").css("display", "none");
                //map.invalidateSize();
                
                //OPEN ABOUT DIALOG
                $('#aboutModal').modal();

                //Show SIDEBAR
                //if (document.body.clientWidth <= 767) {
                
            });
            $(window).resize(function() {
                $(".tt-dropdown-menu").css("max-height", $("#container").height()-$(".navbar").height()-20);
                if (document.body.clientWidth <= 767) {
                    $("#map").css("class", "col-sm-12 col-lg-12");
                    $("#sidebar, #chart-container").hide();
                } else {
                    $("#map").css("class", "col-sm-7 col-lg-7");
                    $("#sidebar, #chart-container").show();
                };
                $('.js-masonry').masonry();
            });

            $("#toggle").click(function() {
                $("#toggle i").toggleClass("glyphicon glyphicon-stats glyphicon glyphicon-map-marker");
                $("#map").toggleClass("col-sm-7 col-lg-7 col-sm-12 col-lg-12");
                $("#sidebar, #chart-container").toggle();
                if (document.body.clientWidth <= 767) {
                    $("#map").toggle();
                };
                map.invalidateSize();
                return false;
            });


            var icon = L.icon({
                iconUrl: 'img/retail.png',
                iconSize: [28, 36],
                iconAnchor: [14,36],
                popupAchor: [14,0]
            });

            var activeIcon = L.icon({
                iconUrl: 'img/Retail_Red.png',
                iconSize: [28, 36],
                iconAnchor: [14,36],
                popupAchor: [14,0]
            });
            // Basemap Layers
            var OpenCycleMap = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
                maxZoom: 18, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
              });
            var mapquestOAM = L.tileLayer("https://oatile{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg", {
                subdomains: '1234',
                attribution: 'Tiles Courtesy of <a href="https://www.mapquest.com/">MapQuest</a> &mdash; Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency'
            });

            // Overlay Layers
            var districts = L.geoJson(null, {
                style: {
                    color: '#0078ae',
                    weight: 3,
                    opacity: 1
                },
                clickable: false
            });
            $.getJSON('districts.js', function (data) {
                districts.addData(data);
            });

            var retail = L.geoJson(null, {
                pointToLayer: function (feature, latlng) {
                    return L.marker(latlng, {
                        icon: icon,
                        title: feature.properties.District,
                        riseOnHover: true,
                    }).on('add', function(e) {
                        $(e.target._icon).tooltip();
                    });
                },
                onEachFeature: onEachFeature
            });
            $.getJSON('rd.js', function (data) {
                retail.addData(data);
                map.fitBounds(retail.getBounds());

                //D3 code here
                update(data.features);

                update(data.features);
                //end D3

                var props = [];
                for (var i = 0; i < data.features.length; i++) {
                    props.push(data.features[i].properties);
                }
                // instantiate the bloodhound suggestion engine
                var ac = new Bloodhound({
                  datumTokenizer: function(d) { return Bloodhound.tokenizers.nonword(d.District); },
                  queryTokenizer: Bloodhound.tokenizers.whitespace,
                  local: props
                });
                 
                // initialize the bloodhound suggestion engine
                ac.initialize();
                 
                // instantiate the typeahead UI
                $('.searchbox').typeahead(null, {
                  displayKey: 'District',
                  source: ac.ttAdapter()
                }).on('typeahead:selected', function (e, suggestion) {
                    $('#map img[data-original-title="'+suggestion.District+'"]').click();
                    $('.modal').modal('hide');
                });
                window.ac = ac;
            });

            map = L.map("map", {
                center: [40, -75],
                zoom: 9,
                layers: [OpenCycleMap, districts, retail],
                zoomControl: false
            });
            map.addControl(L.control.zoom({
                position: 'topright'
            }));

            // Highlight search box text on click
            $(".searchbox").click(function () {
                $(this).select();
            });


            // Placeholder hack for IE
            if (navigator.appName == "Microsoft Internet Explorer") {
                $("input").each( function () {
                    if ($(this).val() == "" && $(this).attr("placeholder") != "") {
                        $(this).val($(this).attr("placeholder"));
                        $(this).focus(function () {
                            if ($(this).val() == $(this).attr("placeholder")) $(this).val("");
                        });
                        $(this).blur(function () {
                            if ($(this).val() == "") $(this).val($(this).attr("placeholder"));
                        });
                    }
                });
            }

            var w, h, r, ir, textOffset, tweenDuration, lines, valueLabels, nameLabels, pieData, oldPieData, filteredPieData, arc, vis, arc_group, label_group, center_group, paths, whiteCircle, totalValue;
            function setupd3() {
            //D3 custom code - https://jsfiddle.net/stephenboak/hYuPb/

            $('#easy-as-pie-chart').empty();
            w = $('#easy-as-pie-chart').parent().width();
            h = w;
            r = w/2.75;
            ir = r/2.4;
            textOffset = 10;
            tweenDuration = 250;

            //OBJECTS TO BE POPULATED WITH DATA LATER
            pieData = [];    
            oldPieData = [];
            filteredPieData = [];

            //D3 helper function to draw arcs, populates parameter "d" in path object
            arc = d3.svg.arc()
              .startAngle(function(d){ return d.startAngle; })
              .endAngle(function(d){ return d.endAngle; })
              .innerRadius(ir)
              .outerRadius(r);

            ///////////////////////////////////////////////////////////
            // CREATE VIS & GROUPS ////////////////////////////////////
            ///////////////////////////////////////////////////////////

            vis = d3.select("#easy-as-pie-chart").append("svg:svg")
              .attr("width", w)
              .attr("height", h);

            //GROUP FOR ARCS/PATHS
            arc_group = vis.append("svg:g")
              .attr("class", "arc")
              .attr("transform", "translate(" + (w/2) + "," + (h/2) + ")");

            //GROUP FOR LABELS
            label_group = vis.append("svg:g")
              .attr("class", "label_group")
              .attr("transform", "translate(" + (w/2) + "," + (h/2) + ")");

            //GROUP FOR CENTER TEXT  
            center_group = vis.append("svg:g")
              .attr("class", "center_group")
              .attr("transform", "translate(" + (w/2) + "," + (h/2) + ")");

            //PLACEHOLDER GRAY CIRCLE
            paths = arc_group.append("svg:circle")
                .attr("fill", "#EFEFEF")
                .attr("r", r);

            ///////////////////////////////////////////////////////////
            // CENTER TEXT ////////////////////////////////////////////
            ///////////////////////////////////////////////////////////

            //WHITE CIRCLE BEHIND LABELS
            whiteCircle = center_group.append("svg:circle")
              .attr("fill", "white")
              .attr("r", ir);

            //TOTAL TRAFFIC VALUE
            totalValue = center_group.append("svg:text")
              .attr("class", "label")
              .attr("dy", 0)
              .attr("text-anchor", "middle");
            totalValue
              .append("svg:tspan")
              .attr("x", 0)
              .text("RETAIL");
            totalValue
              .append("svg:tspan")
              .attr("x", 0)
              .attr("dy", "1.2em")
              .text("MIX");


              ///////////////////////////////////////////////////////////
              // LEGEND /////////////////////////////////////////////////
              ///////////////////////////////////////////////////////////
              //var legend = 

          }
          setupd3();


            function update(data) {

              var fields = [
                {name: "NGS", label: 'NG&S', fill: '#5895B9', value: 0},
                {name: "FB", label: 'F&B', fill: '#79AAC7', value: 0},
                {name: "GAFO", label: 'GAFO', fill: '#9BBFD5', value: 0},
                {name: "NONREOFF", label: 'Office', fill: '#2C4B5D', value: 0},
                {name: "RESIDE", label: 'Res.', fill: '#C66554', value: 0},
                {name: "CivCUl", label: 'Civic&Cultural', fill: '#42708A', value: 0},
                //{name: "CULT", label: 'Cultural', fill: '#42708A', value: 0},
                {name: "VACANT", label: 'Vacant', fill: '#A7A9AC', value: 0}
              ];

              var donut = d3.layout.pie()
                .sort(function (a, b) {
                    return a.name.localeCompare(b.name);
                }).value(function (item, index) {
                    return fields[index].value;
                });
              for (var x = 0; x < data.length; x++) {
                var feature = data[x];
                for (var i = 0; i < fields.length; i++) {
                    fields[i].value += feature.properties[fields[i].name];
                }
              }

              oldPieData = filteredPieData;
              pieData = donut(fields);

              var totalValue = 0;
              filteredPieData = pieData.filter(function (element, index, array) {
                element.name = fields[index].label;
                element.value = parseFloat(fields[index].value.toFixed(3));
                element.fill = fields[index].fill;
                totalValue += element.value;
                return (element.value > 0);
              }).sort(function (a, b) {
                    return a.name.localeCompare(b.name);
                });

              
              if(filteredPieData.length > 0 && oldPieData.length > 0){

                //REMOVE PLACEHOLDER CIRCLE
                arc_group.selectAll("circle").remove();

                //DRAW ARC PATHS
                paths = arc_group.selectAll("path").data(filteredPieData);
                paths.enter().append("svg:path")
                  .attr("stroke", "white")
                  .attr("stroke-width", 0.5)
                  .transition()
                    .duration(tweenDuration)
                    .attrTween("d", pieTween);
                paths
                  .attr("fill", function(d, i) { return d.fill; })
                  .transition()
                    .duration(tweenDuration)
                    .attrTween("d", pieTween);
                paths.exit()
                  .transition()
                    .duration(tweenDuration)
                    .attrTween("d", removePieTween)
                  .remove();

                /*paths.on('mouseover', function () {
                    d3.select(this).attr('transform', 'scale(1.05)');
                }).on('mouseout', function () {
                    d3.select(this).attr('transform', '');
                }).on('click', function () {
                    console.log(d3.select(this).style('filter'));
                    var el = d3.select(this);
                    if (el.attr('fill') == '#cccccc') {
                        el.attr('fill', el.attr('data-fill'));
                    }
                    else {
                        el.attr('data-fill', el.attr('fill'));
                        el.attr('fill', '#cccccc');
                    }
                });*/

                //DRAW TICK MARK LINES FOR LABELS
                /*lines = label_group.selectAll("line").data(filteredPieData);
                lines.enter().append("svg:line")
                  .attr("x1", 0)
                  .attr("x2", 0)
                  .attr("y1", -r-3)
                  .attr("y2", -r-8)
                  .attr("stroke", "gray")
                  .attr("transform", function(d) {
                    return "rotate(" + (d.startAngle+d.endAngle)/2 * (180/Math.PI) + ")";
                  });
                lines.transition()
                  .duration(tweenDuration)
                  .attr("transform", function(d) {
                    return "rotate(" + (d.startAngle+d.endAngle)/2 * (180/Math.PI) + ")";
                  });
                lines.exit().remove();*/

                //DRAW LABELS WITH PERCENTAGE VALUES
                valueLabels = label_group.selectAll("text.value").data(filteredPieData)
                  .attr("dy", function(d){
                    return 0;
                    if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
                      return 5;
                    } else {
                      return -7;
                    }
                  })
                  .attr("text-anchor", function(d){
                    if ( (d.startAngle+d.endAngle)/2 < Math.PI ){
                      return "beginning";
                    } else {
                      return "end";
                    }
                  })
                  .text(function(d){
                    var percentage = (d.value/totalValue)*100;
                    return percentage.toFixed(1) + "%";
                  });

                valueLabels.enter().append("svg:text")
                  .attr("class", "value")
                  .attr("transform", function(d, i) {
                    return "translate(" + Math.cos(((d.startAngle+d.endAngle - Math.PI)/2)) * (r+textOffset) + "," + Math.sin((d.startAngle+d.endAngle - Math.PI)/2) * (r+textOffset) + ")";
                  })
                  .attr("dy", function(d){
                    return 0;
                    if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
                      return 5;
                    } else {
                      return -7;
                    }
                  })
                  .attr("text-anchor", function(d){
                    if ( (d.startAngle+d.endAngle)/2 < Math.PI ){
                      return "beginning";
                    } else {
                      return "end";
                    }
                  }).text(function(d){
                    var percentage = (d.value/totalValue)*100;
                    return percentage.toFixed(1) + "%";
                  });

                valueLabels.transition().duration(tweenDuration).attrTween("transform", textTween);

                valueLabels.exit().remove();


                //DRAW LABELS WITH ENTITY NAMES
                nameLabels = label_group.selectAll("text.units").data(filteredPieData)
                  .attr("dy", function(d){
                    if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
                      return 17;
                    } else {
                      return 5;
                    }
                  })
                  .attr("text-anchor", function(d){
                    if ((d.startAngle+d.endAngle)/2 < Math.PI ) {
                      return "beginning";
                    } else {
                      return "end";
                    }
                  })/*.text(function(d){
                    return d.name;
                  });*/

                nameLabels.enter().append("svg:text")
                  .attr("class", "units")
                  .attr("transform", function(d) {
                    return "translate(" + Math.cos(((d.startAngle+d.endAngle - Math.PI)/2)) * (r+textOffset) + "," + Math.sin((d.startAngle+d.endAngle - Math.PI)/2) * (r+textOffset) + ")";
                  })
                  .attr("dy", function(d){
                    if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
                      return 17;
                    } else {
                      return 5;
                    }
                  })
                  .attr("text-anchor", function(d){
                    if ((d.startAngle+d.endAngle)/2 < Math.PI ) {
                      return "beginning";
                    } else {
                      return "end";
                    }
                  })/*.text(function(d){
                    return d.name;
                  });*/

                nameLabels.transition().duration(tweenDuration).attrTween("transform", textTween);

                nameLabels.exit().remove();
              }  
            }

            ///////////////////////////////////////////////////////////
            // FUNCTIONS //////////////////////////////////////////////
            ///////////////////////////////////////////////////////////

            // Interpolate the arcs in data space.
            function pieTween(d, i) {
              var s0;
              var e0;
              if(oldPieData[i]){
                s0 = oldPieData[i].startAngle;
                e0 = oldPieData[i].endAngle;
              } else if (!(oldPieData[i]) && oldPieData[i-1]) {
                s0 = oldPieData[i-1].endAngle;
                e0 = oldPieData[i-1].endAngle;
              } else if(!(oldPieData[i-1]) && oldPieData.length > 0){
                s0 = oldPieData[oldPieData.length-1].endAngle;
                e0 = oldPieData[oldPieData.length-1].endAngle;
              } else {
                s0 = 0;
                e0 = 0;
              }
              var i = d3.interpolate({startAngle: s0, endAngle: e0}, {startAngle: d.startAngle, endAngle: d.endAngle});
              return function(t) {
                var b = i(t);
                return arc(b);
              };
            }

            function removePieTween(d, i) {
              s0 = 2 * Math.PI;
              e0 = 2 * Math.PI;
              var i = d3.interpolate({startAngle: d.startAngle, endAngle: d.endAngle}, {startAngle: s0, endAngle: e0});
              return function(t) {
                var b = i(t);
                return arc(b);
              };
            }

            function textTween(d, i) {
              var a;
              if(oldPieData[i]){
                a = (oldPieData[i].startAngle + oldPieData[i].endAngle - Math.PI)/2;
              } else if (!(oldPieData[i]) && oldPieData[i-1]) {
                a = (oldPieData[i-1].startAngle + oldPieData[i-1].endAngle - Math.PI)/2;
              } else if(!(oldPieData[i-1]) && oldPieData.length > 0) {
                a = (oldPieData[oldPieData.length-1].startAngle + oldPieData[oldPieData.length-1].endAngle - Math.PI)/2;
              } else {
                a = 0;
              }
              var b = (d.startAngle + d.endAngle - Math.PI)/2;

              var fn = d3.interpolateNumber(a, b);
              return function(t) {
                var val = fn(t);
                return "translate(" + Math.cos(val) * (r+textOffset) + "," + Math.sin(val) * (r+textOffset) + ")";
              };
            }
        </script>
        <script>var _gaq=[['_setAccount','UA-9825778-1'],['_trackPageview']];(function(d){var g=d.createElement('script'),s=d.scripts[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document))</script>
    </body>
</html>